worker_processes auto;

events { worker_connections 1024; }

http {
  # Global anti-flood
  limit_req_zone $binary_remote_addr zone=rl_global:10m rate=120r/m;

  # Auth
  limit_req_zone $binary_remote_addr zone=rl_auth:10m rate=10r/m;

  # Users
  limit_req_zone $binary_remote_addr zone=rl_users:10m rate=60r/m;
  limit_req_zone $binary_remote_addr zone=rl_user_by_id:10m rate=30r/m;

  # Agreements
  limit_req_zone $binary_remote_addr zone=rl_agreements_list:10m rate=60r/m;
  limit_req_zone $binary_remote_addr zone=rl_agreement_detail:10m rate=120r/m;

  # Disputes
  limit_req_zone $binary_remote_addr zone=rl_dispute_resolve:10m rate=5r/m;

  upstream backend {
    server backend:8000;
    keepalive 32;
  }

  server {
    listen 80;
    server_name _;

    limit_req_status 429;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Global fallback
    location / {
      limit_req zone=rl_global burst=20 nodelay;
      proxy_pass http://backend;
    }

    # ========== AUTH ==========
    location ^~ /api/auth/ {
      limit_req zone=rl_auth burst=10 nodelay;
      proxy_pass http://backend;
    }

    # ========== USERS ==========
    location = /api/v1/users/me {
      limit_req zone=rl_users burst=20 nodelay;
      proxy_pass http://backend;
    }

    # /users/{id}
    location ~ ^/api/v1/users/[^/]+$ {
      limit_req zone=rl_user_by_id burst=10 nodelay;
      proxy_pass http://backend;
    }

    # ========== AGREEMENTS ==========
    location = /api/v1/agreements {
      limit_req zone=rl_agreements_list burst=20 nodelay;
      proxy_pass http://backend;
    }

    location ~ ^/api/v1/agreements/[^/]+$ {
      limit_req zone=rl_agreement_detail burst=30 nodelay;
      proxy_pass http://backend;
    }

    location ~ ^/api/v1/agreements/[^/]+/dispute$ {
      limit_req zone=rl_agreement_detail burst=15 nodelay;
      proxy_pass http://backend;
    }

    location ~ ^/api/v1/agreements/[^/]+/dispute/resolve$ {
      limit_req zone=rl_dispute_resolve burst=2 nodelay;
      proxy_pass http://backend;
    }
  }
}

